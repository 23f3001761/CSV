<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Summary 1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding-top: 1rem; }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="h3 mb-3">Sales Summary 1</h1>
    <div class="mb-3">
      Total Sales: Rs. <span id="total-sales" class="fw-semibold">0</span>
    </div>

    <table class="table table-striped" id="product-sales" aria-label="Product sales totals">
      <thead>
        <tr>
          <th scope="col">Product</th>
          <th scope="col">Total Sales (Rs.)</th>
        </tr>
      </thead>
      <tbody id="product-sales-body">
        <!-- rows injected by JavaScript -->
      </tbody>
    </table>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const totalEl = document.getElementById('total-sales');
      const tbody = document.getElementById('product-sales-body');
      let total = 0;
      const perProduct = new Map();

      async function loadAndRender() {
        try {
          const res = await fetch('data.csv');
          if (!res.ok) throw new Error('Failed to load data.csv');
          const text = await res.text();

          // reset
          total = 0;
          perProduct.clear();
          tbody.innerHTML = '';

          // split lines (handle CRLF or LF)
          const lines = text.trim().split(/\r?\n/);
          if (lines.length < 1) {
            totalEl.textContent = '0';
            return;
          }

          // parse header
          const header = parseCSVLine(lines[0]);
          const idxProduct = header.findIndex(h => h === 'Product');
          const idxSales = header.findIndex(h => h === 'Sales(Rs.)');
          if (idxProduct < 0 || idxSales < 0) {
            totalEl.textContent = '0';
            return;
          }

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = parseCSVLine(line);
            const product = cols[idxProduct] ?? '';
            const salesStr = cols[idxSales] ?? '0';
            // extract numeric from possibly formatted string
            const sales = parseFloat(salesStr.replace(/[^0-9.\-]/g, '')) || 0;
            total += sales;
            perProduct.set(product, (perProduct.get(product) || 0) + sales);
          }

          // render product rows
          for (const [product, sum] of perProduct.entries()) {
            const tr = document.createElement('tr');
            const tdProduct = document.createElement('td');
            tdProduct.textContent = product;
            const tdSum = document.createElement('td');
            tdSum.textContent = sum.toFixed(0);
            tr.appendChild(tdProduct);
            tr.appendChild(tdSum);
            tbody.appendChild(tr);
          }

          totalEl.textContent = total.toFixed(0);
        } catch (err) {
          totalEl.textContent = '0';
          console.error(err);
        }
      }

      function parseCSVLine(line) {
        // Robust CSV line parser handling quotes
        const result = [];
        let cur = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === ',' && !inQuotes) {
            result.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
        result.push(cur);
        return result.map(s => s.trim().replace(/^"|"$/g, ''));
      }

      await loadAndRender();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>