<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Sales Summary 1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding-top: 1rem; }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="mb-4">Sales Summary 1</h1>

    <div class="row g-3 align-items-end mb-4">
      <div class="col-md-6">
        <label for="currency-picker" class="form-label">Currency</label>
        <select id="currency-picker" class="form-select" aria-label="Choose currency for conversion">
          <option value="INR" selected>INR</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="JPY">JPY</option>
          <option value="GBP">GBP</option>
          <option value="AUD">AUD</option>
        </select>
      </div>
      <div class="col-md-6">
        <div class="text-end">
          <div class="fw-semibold mb-1">Converted total</div>
          <div id="total-currency" class="fs-4" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Total Sales (INR)</h5>
        <p id="total-sales" class="display-4 mb-0">â‚¹0.00</p>
        <div class="text-muted small">Base: INR</div>
      </div>
    </div>

    <div id="status" class="text-danger"></div>
  </main>

  <script>
  (async function(){
    // Elements
    const totalSalesEl = document.getElementById('total-sales');
    const totalCurrencyEl = document.getElementById('total-currency');
    const currencyPicker = document.getElementById('currency-picker');
    const statusEl = document.getElementById('status');

    // Data
    let totalINR = 0;
    let rates = {};

    // Helpers
    function formatCurrencyLocal(n, code){
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: code }).format(n);
      } catch(e){
        return code + ' ' + n.toFixed(2);
      }
    }

    // Compute converted total and render
    function updateConverted(){
      const code = currencyPicker.value;
      let converted;
      if (code === 'INR' || !rates || !rates[code]) {
        converted = totalINR;
      } else {
        const rate = Number(rates[code]);
        if (!Number.isFinite(rate) || rate <= 0) {
          statusEl.textContent = 'Invalid rate for ' + code;
          return;
        }
        converted = totalINR / rate;
      }
      totalCurrencyEl.textContent = formatCurrencyLocal(converted, code);
      statusEl.textContent = '';
    }

    // Sum the Sales(Rs.) column from data.csv
    function sumSalesFromCSV(text){
      // Split into lines using CRLF/LF only
      const lines = text.split(/\r?\n/);
      if (!lines.length) return 0;
      const header = lines[0].split(',').map(s => s.trim());
      let idx = -1;
      for (let i = 0; i < header.length; i++){
        if (header[i] === 'Sales(Rs.)'){
          idx = i; break;
        }
      }
      if (idx < 0){
        for (let i = 0; i < header.length; i++){
          if (header[i].trim().toLowerCase() === 'sales(rs).'.toLowerCase()) { idx = i; break; }
        }
      }
      if (idx < 0) idx = header.length - 1;
      let sum = 0;
      for (let r = 1; r < lines.length; r++){
        const line = lines[r];
        if (!line) continue;
        const parts = line.split(',');
        const val = parseFloat(parts[idx]);
        if (!isNaN(val)) sum += val;
      }
      return sum;
    }

    // Load data.csv
    try {
      const res = await fetch('data.csv');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      totalINR = sumSalesFromCSV(text);
      totalSalesEl.textContent = formatCurrencyLocal(totalINR, 'INR');
      statusEl.textContent = '';
    } catch(err){
      statusEl.textContent = 'Error loading data.csv: ' + err.message;
      totalINR = 0;
      totalSalesEl.textContent = formatCurrencyLocal(totalINR, 'INR');
    }

    // Load rates.json
    try {
      const resRates = await fetch('rates.json');
      if (resRates.ok) {
        const json = await resRates.json();
        if (typeof json === 'object' && json !== null) {
          rates = json;
        }
      }
    } catch(e){
      // ignore errors and proceed without rates
    }

    // Initial conversion display
    updateConverted();

    currencyPicker.addEventListener('change', updateConverted);

  })();
  </script>
</body>
</html>